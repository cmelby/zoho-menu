<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Genosis â€¢ Product Menu</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c10; --panel:#111318; --stroke:#1f2937; --muted:#9ca3af; --text:#e5e7eb;
      --accent1:#d4af37; --accent2:#b57f2a;
      --radius:16px;
      --header-h:78px; --header-h-compact:64px;
      --logo-h:64px; --logo-h-compact:48px;
      --section-nav-h:52px;
    }
    @media (max-width:640px){
      :root{ --header-h:72px; --header-h-compact:60px; --logo-h:60px; --logo-h-compact:46px; }
    }

    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--text)}

    /* ===== HEADER ===== */
  /* header-wrap becomes a fixed, full-width header block containing the header, toolbar, and nav */
  .header-wrap{position:fixed;inset:0 0 auto 0;top:0;left:0;right:0;z-index:110;background:rgba(11,12,16,.92);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,0.03)}
    .header{
      height:var(--header-h);display:flex;align-items:center;gap:12px;max-width:1200px;margin:0 auto;
      padding:12px 20px;/* inner container no longer draws full-width border */
      transition:height .18s ease,padding .18s ease;
      position:relative; /* ensure header creates its own stacking context */
      z-index:140; /* sit above the section-nav */
    }
  .header__left,.header__center,.header__right{display:flex;align-items:center;gap:12px;}
  /* left column defines the page content left edge (matches centered max-width) */
  .header__left{flex:0 0 320px;justify-content:flex-start;padding-left:20px}
  .header__center{flex:1 1 auto;position:relative;display:flex;justify-content:center}
  .header__right{flex:0 0 320px;justify-content:flex-end;padding-right:20px}
  /* visually center the logo over the header while other items align to the left/right columns */
  .logo{height:var(--logo-h);width:auto;display:block;transition:height .18s ease;position:absolute;left:50%;transform:translateX(-50%);top:50%;transform:translate(-50%,-50%)}
  .brandline{font-size:14px;color:var(--text);display:flex;align-items:center;gap:8px;font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    /* Make the Product Menu text use the same gold gradient as the logo and larger */
    .brandline .muted{
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      font-weight:700;
      font-size:20px;
      letter-spacing:0.01em;
      font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      text-align:left;
    }
    .header--centered .header{height:var(--header-h-compact);}
    .header--centered .logo{height:var(--logo-h-compact);}
    .header--centered .header__left,.header--centered .header__right{visibility:hidden;width:0;flex:0 0 0;}
  .header--centered .brandline{display:flex;}

    /* ===== TOOLBAR ===== */
  .toolbar{display:flex;gap:10px;align-items:center;padding:10px 20px;max-width:1200px;margin:0 auto;background:transparent;position:relative;z-index:130}
    input,select,button{border-radius:10px;border:1px solid var(--stroke);background:#0f1115;color:var(--text);padding:10px 12px}
    button{cursor:pointer;background:#1f2937;transition:background .15s ease,border-color .15s ease,box-shadow .15s ease}
    button:hover{background:#2b3648}
  /* add top padding so content isn't covered by the fixed header + section nav */
  .content{padding:20px;padding-top:calc(var(--header-h) + var(--section-nav-h) + 8px)}

    /* ===== CARDS ===== */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{
      background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px;
      display:flex;flex-direction:column;min-height:300px; /* a bit taller for consistent alignment */
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .card:hover{border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1),0 10px 22px rgba(0,0,0,.28)}
    .title{font-size:18px;margin:0 0 6px;line-height:1.2}

    .price-line{display:flex;gap:6px;align-items:baseline;margin:0 0 10px}
    .price-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    .price{font-weight:700}

    .desc-wrap{margin-top:2px}
    .desc-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin:0 0 6px}
    .desc{
      font-size:13px;color:var(--muted);margin:0;
      display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden
    }

    .spacer{flex:1 1 auto} /* pushes selector + buttons to bottom for alignment */

    .row{display:flex;gap:8px;align-items:center}
    .row-end{margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sku{font-size:11px;color:var(--muted);max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .select{width:100%;border-radius:10px;border:1px solid var(--stroke);background:#0f1115;color:var(--text);padding:8px 10px;transition:border-color .15s ease, box-shadow .15s ease}
    .select:focus{outline:none;border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1)}
    .cta{padding:10px 12px;border:1px solid var(--stroke);background:#0f1115}
    .cta:hover{border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1)}
    .cta[disabled]{opacity:.55;cursor:not-allowed}

    /* ===== BANNER ===== */
    .banner{background:#1f2937;border:1px solid var(--stroke);padding:10px 12px;border-radius:12px;margin:12px 20px 0;font-size:12px;color:#d1d5db}
    .warn{color:var(--accent1);font-weight:600}

  /* ===== SECTION NAV ===== */
  /* make the section nav fixed so it stays visible as you scroll */
  /* section-nav is now part of the header-wrap and flows naturally below the toolbar */
  /* keep nav items on one line and allow horizontal scroll to avoid wrapping */
  /* keep the nav visually below the header/toolbar and restrict it to one row */
  /* align nav with left column by using same left padding as header__left */
  #section-nav{display:flex;gap:10px;flex-wrap:nowrap;overflow-x:auto;padding:8px 20px;max-width:1200px;margin:0 auto;align-items:center;position:relative;z-index:110;max-height:var(--section-nav-h);overflow-y:hidden}
  #section-nav::-webkit-scrollbar{height:8px}
  #section-nav{scrollbar-width:thin}
    #section-nav a{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid var(--stroke);border-radius:10px;text-decoration:none;display:inline-block;white-space:nowrap}
    #section-nav a:hover{border-color:var(--accent1)}

  /* Make the visual separators extend to the viewport edges by drawing
     subtle borders on the header-wrap itself and reducing inner container
     borders. Also tighten spacing on small screens. */
  @media (max-width:960px){
  .header{padding:10px 12px;}
  .header__left{flex:0 0 220px;padding-left:12px}
  .header__right{flex:0 0 220px;padding-right:12px}
  .toolbar{padding:8px 12px;gap:8px}
  #section-nav{padding:6px 12px;gap:8px}
  .brandline .muted{font-size:18px}
  }
  @media (max-width:480px){
  .header{padding:8px 8px}
  .brandline .muted{font-size:15px}
  /* on very small screens, don't absolutely center the logo (it overlaps) */
  .logo{position:static;transform:none;height:var(--logo-h-compact)}
  .header__left{flex:1 1 auto;padding-left:8px}
  .header__right{flex:1 1 auto;padding-right:8px}
  .toolbar{flex-wrap:wrap;gap:8px;justify-content:flex-start}
  #section-nav{overflow-x:auto}
  }

    /* ===== SECTIONS ===== */
    .section{margin:16px 0 8px}
    .section__title{font-size:18px;margin:14px 0 8px 4px;color:var(--text);border-left:3px solid var(--accent1);padding-left:10px}
    .section__grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    @media (min-width:1280px){ .section__grid{ grid-template-columns:repeat(auto-fit,minmax(300px,1fr)) } }

    /* ===== MODAL ===== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
    .modal-card{width:100%;max-width:480px;background:#0f1115;border:1px solid var(--stroke);border-radius:var(--radius);padding:18px}
    .modal-card h2{margin:0 0 12px}
    .modal .row{display:flex;gap:8px;margin-top:8px}
    .modal input,.modal textarea{width:100%;border-radius:10px;border:1px solid var(--stroke);background:#0f1115;color:var(--text);padding:10px}
    .modal input:focus,.modal textarea:focus{outline:none;border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1)}
    .modal textarea{height:90px}
    .modal .btn{padding:10px 12px;border:1px solid var(--stroke);background:#0f1115}
    .modal .btn:hover{border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1)}
  </style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <div class="header-wrap" id="headerWrap">
    <div class="header" id="header">
      <div class="header__left">
        <div class="brandline"><span class="muted">Product Menu</span></div>
      </div>
      <div class="header__center">
        <img src="/logo-genosis.png" alt="Genosis" class="logo" id="logo" />
      </div>
      <div class="header__right"></div>
    </div>

    <div class="toolbar">
      <input id="search" placeholder="Search products..." />
      <select id="perPage">
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="200" selected>200</option>
      </select>
      <button id="refresh">Refresh</button>
    </div>

    <div id="section-nav"></div>
  </div>

  <div class="banner" id="banner" style="display:none;"></div>

  <div class="content"><div id="sections"></div></div>

  <!-- MODAL -->
  <div class="modal" id="leadModal">
    <div class="modal-card">
      <h2 id="modalTitle">Place order</h2>
      <div class="row"><input id="firstName" placeholder="First name" required /></div>
      <div class="row"><input id="lastName" placeholder="Last name" required /></div>
      <div class="row"><input id="email" type="email" placeholder="Email" required /></div>
      <div class="row"><input id="phone" placeholder="Phone" required /></div>
      <div class="row"><textarea id="notes" placeholder="Notes (optional)"></textarea></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" id="cancelBtn" style="padding:10px 12px;border:1px solid var(--stroke);background:#0f1115;">Cancel</button>
        <button class="btn" id="createLeadBtn" style="padding:10px 12px;border:1px solid var(--stroke);background:#0f1115;">Submit</button>
      </div>
    </div>
  </div>

  <!-- HEADER SCROLL -->
  <script>
    (function(){
      const headerWrap = document.getElementById('headerWrap');
      let centered=false;
      function onScroll(){
        const shouldCenter = window.scrollY>40;
        if(shouldCenter!==centered){ centered=shouldCenter; headerWrap.classList.toggle('header--centered', centered); }
      }
      onScroll(); window.addEventListener('scroll', onScroll, {passive:true});
    })();
  </script>

  <script>
    // Keep content padded below the fixed headerWrap (which now contains
    // header, toolbar, and section nav). This responds to header compacting
    // and nav size changes.
    (function(){
      const headerWrap = document.getElementById('headerWrap');
      const content = document.querySelector('.content');
      const nav = document.getElementById('section-nav');

      function refresh(){
        if(!headerWrap || !content) return;
        const h = headerWrap.offsetHeight || 0;
        content.style.paddingTop = (h + 8) + 'px';
      }

      window.addEventListener('load', refresh);
      window.addEventListener('resize', refresh);
      window.addEventListener('scroll', refresh);

      const obs = new MutationObserver(refresh);
      if(nav) obs.observe(nav, {childList:true,subtree:true});

      setTimeout(refresh, 50);
    })();
  </script>

  <!-- MENU APP -->
  <script>
    /* === Weight options driven by Zoho "unit" (Usage Unit) === */
    const WEIGHT_OPTIONS_BY_UNIT = {
      kg: ['250 g','500 g','1 kg','5 kg','10 kg','25 kg'],
      g:  ['100 g','250 g','500 g','1 kg'],
      lb: ['1 lb','5 lb','10 lb','25 lb'],
      oz: ['1 oz','2 oz','4 oz','8 oz','16 oz'],
      l:  ['100 mL','250 mL','500 mL','1 L','5 L'],
      ml: ['100 mL','250 mL','500 mL','1000 mL'],
      unit: ['10 ct','25 ct','50 ct','100 ct'],
      pcs:  ['10 ct','25 ct','50 ct','100 ct'],
      tablet:['100 ct','250 ct','500 ct','1000 ct']
    };
    const DEFAULT_WEIGHTS = ['250 g','500 g','1 kg','5 kg','10 kg'];

    function optionsForUnit(uRaw){
      const u = (uRaw||'').toString().trim().toLowerCase();
      if(WEIGHT_OPTIONS_BY_UNIT[u]) return WEIGHT_OPTIONS_BY_UNIT[u];
      if(u==='kilogram'||u==='kgs') return WEIGHT_OPTIONS_BY_UNIT['kg'];
      if(u==='pound'||u==='lbs')   return WEIGHT_OPTIONS_BY_UNIT['lb'];
      if(u==='liter')              return WEIGHT_OPTIONS_BY_UNIT['l'];
      if(u==='milliliter')         return WEIGHT_OPTIONS_BY_UNIT['ml'];
      if(u==='piece'||u==='each')  return WEIGHT_OPTIONS_BY_UNIT['unit'];
      return DEFAULT_WEIGHTS;
    }

    /* === Group strictly by Zoho built-in category_name === */
    function normalizeStr(v){ return v==null ? '' : String(v).trim(); }
    function isJunk(v){ const s=normalizeStr(v).toLowerCase(); return !s||['uncategorized','n/a','na','-'].includes(s); }
    function getSection(item){ const c=normalizeStr(item.category_name); return !isJunk(c)?c:'Other'; }
    function buildSections(items){
      const m=new Map();
      for(const it of items){ const sec=getSection(it); if(!m.has(sec)) m.set(sec,[]); m.get(sec).push(it); }
      const keys=[...m.keys()];
      const real=keys.filter(k=>k!=='Other');
      const ordered=(real.length?real:['Other']).sort((a,b)=>a.localeCompare(b));
      return {ordered,buckets:m};
    }

    /* === UI refs === */
    const banner=document.getElementById('banner');
    const search=document.getElementById('search');
    const perPage=document.getElementById('perPage');
    const refreshBtn=document.getElementById('refresh');
    const sectionsEl=document.getElementById('sections');
    const navEl=document.getElementById('section-nav');

    const leadModal=document.getElementById('leadModal');
    const modalTitle=document.getElementById('modalTitle');
    const firstNameEl=document.getElementById('firstName');
    const lastNameEl=document.getElementById('lastName');
    const emailEl=document.getElementById('email');
    const phoneEl=document.getElementById('phone');
    const notesEl=document.getElementById('notes');
    const cancelBtn=document.getElementById('cancelBtn');
    const createLeadBtn=document.getElementById('createLeadBtn');

    /* === State === */
    let allItems=[]; let preview=false; let selectedProduct=null; let selectedWeight='';

    const DEMO_ITEMS=[{id:'1',name:'Demo Product',rate:100,description:'Demo',sku:'DEMO',category_name:'Sample',unit:'kg'}];

    /* === Data === */
    async function fetchItems(page=1){
      const res=await fetch(`/api/items?page=${page}&per_page=${perPage.value}`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }
    async function loadAll(){
      sectionsEl.innerHTML='';
      let page=1, items=[], more=true;
      try{
        while(more){
          const data=await fetchItems(page);
          const chunk=(data.items||[]).map(x=>({
            id:x.item_id, name:x.name, rate:x.rate,
            description:(x.description||'').trim(),
            sku:x.sku||x.item_name||'',
            category_name:x.category_name||'',
            unit:x.unit||'',
            weight_options:(x.weight_options||'').trim()
          }));
          items=items.concat(chunk);
          const ctx=data.page_context||{}; const cur=ctx.page||page; const total=ctx.total_pages||1;
          more=cur<total; page++;
        }
        allItems=items;
      }catch(e){
        preview=true; allItems=DEMO_ITEMS;
        banner.style.display='block';
        banner.innerHTML='<span class="warn">Preview mode:</span> Using sample products (API did not return live data).';
      }
      render();
    }

    /* === Cards & render === */
    function escapeHtml(s){return String(s).replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

    function createCard(item){
      const node=document.createElement('div');
      node.className='card';

      const derived = optionsForUnit(item.unit);
      const explicit = (item.weight_options||'').split(',').map(s=>s.trim()).filter(Boolean);
      const weights = explicit.length ? explicit : derived;
      const unitLabel = (item.unit||'').toString().trim();

      node.innerHTML = `
        <h3 class="title">${escapeHtml(item.name)}</h3>

        <div class="price-line">
          <span class="price-label">Starting&nbsp;at</span>
          <span class="price">$${Number(item.rate||0).toLocaleString()}</span>
        </div>

        <div class="desc-wrap">
          <div class="desc-label">Product Description</div>
          <p class="desc">${escapeHtml(item.description||'')}</p>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <select class="select weight-select" aria-label="Select size">
            <option value="">Select size${unitLabel ? ` (${escapeHtml(unitLabel)})` : ''}</option>
            ${weights.map(w=>`<option value="${escapeHtml(w)}">${escapeHtml(w)}</option>`).join('')}
          </select>
        </div>

        <div class="row-end">
          <span class="sku" title="${escapeHtml(item.sku||'')}">SKU: ${escapeHtml(item.sku||'')}</span>
          <button class="cta place-btn" disabled>Place order</button>
        </div>
      `;

      const weightSel = node.querySelector('.weight-select');
      const btn = node.querySelector('.place-btn');
      weightSel.addEventListener('change', ()=>{ btn.disabled = !weightSel.value; });
      btn.addEventListener('click', ()=>{
        if(!weightSel.value){ alert('Please choose a size.'); return; }
        openLeadModal(item, weightSel.value);
      });

      return node;
    }

    function render(){
      const q=(search.value||'').toLowerCase();
      const filtered=allItems.filter(i => i.name.toLowerCase().includes(q) || (i.sku||'').toLowerCase().includes(q));

      const {ordered, buckets} = buildSections(filtered);

      // Section nav
      navEl.innerHTML='';
      ordered.forEach(sec=>{
        const a=document.createElement('a'); a.textContent=sec; a.href=`#sec-${encodeURIComponent(sec)}`;
        navEl.appendChild(a);
      });

      // Sections
      sectionsEl.innerHTML='';
      if(!ordered.length){
        const empty=document.createElement('div'); empty.className='card'; empty.textContent='No products found.'; sectionsEl.appendChild(empty); return;
      }

      ordered.forEach(sec=>{
        const items=buckets.get(sec)||[]; if(!items.length) return;
        const section=document.createElement('section'); section.className='section'; section.id=`sec-${encodeURIComponent(sec)}`;

        const h=document.createElement('h2'); h.className='section__title'; h.textContent=sec; section.appendChild(h);

        const g=document.createElement('div'); g.className='section__grid';
        items.forEach(it=> g.appendChild(createCard(it)));
        section.appendChild(g);

        sectionsEl.appendChild(section);
      });
    }

    /* ------------ Modal ------------ */
    function openLeadModal(item, weight){
      selectedProduct=item; selectedWeight=weight;
      modalTitle.textContent=`Place order: ${item.name}`;
      firstNameEl.value=''; lastNameEl.value=''; emailEl.value=''; phoneEl.value=''; notesEl.value='';
      leadModal.style.display='flex';
    }
    document.getElementById('cancelBtn').addEventListener('click', ()=>{ leadModal.style.display='none'; selectedProduct=null; selectedWeight=''; });
    document.getElementById('createLeadBtn').addEventListener('click', async ()=>{
      if(!selectedProduct) return;
      if(!firstNameEl.value.trim()){ firstNameEl.focus(); return alert('Please enter your first name.'); }
      if(!lastNameEl.value.trim()){  lastNameEl.focus();  return alert('Please enter your last name.'); }
      if(!emailEl.value.trim()){     emailEl.focus();     return alert('Please enter your email.'); }
      if(!phoneEl.value.trim()){     phoneEl.focus();     return alert('Please enter your phone.'); }

      const payload={
        firstName:firstNameEl.value.trim(),
        lastName:lastNameEl.value.trim(),
        email:emailEl.value.trim(),
        phone:phoneEl.value.trim(),
        productName:selectedProduct.name,
        notes:(notesEl.value||'').trim()?`Selected size: ${selectedWeight}\n${notesEl.value.trim()}`:`Selected size: ${selectedWeight}`
      };

      const res=await fetch('/api/lead',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const json=await res.json().catch(()=> ({}));
      if(!res.ok){ alert('Request failed: '+(json.message||json.error||res.status)); return; }

      alert('Thanks! Your order request has been sent.');
      leadModal.style.display='none'; selectedProduct=null; selectedWeight='';
    });

    /* ------------ Search/Refresh ------------ */
    search.addEventListener('input', render);
    refreshBtn.addEventListener('click', loadAll);

    /* ------------ Boot ------------ */
    loadAll();
  </script>
</body>
</html>

