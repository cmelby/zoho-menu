<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Genosis Product Menu</title>
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #111318;
      --stroke: #1f2937;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --brand: #d1b36b; /* subtle gold accent */
      --radius: 16px;
    }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    /* HEADER */
    .header {
      display: flex; align-items: center; gap: 14px;
      padding: 16px 20px; position: sticky; top: 0; z-index: 10;
      background: rgba(11,12,16,0.9); backdrop-filter: blur(8px); border-bottom: 1px solid var(--stroke);
    }
    .logo { height: 36px; width: auto; display: block; }
    .brand {
      font-size: 14px; color: var(--muted);
      letter-spacing: .02em;
    }
    .brand strong { color: var(--text); }
    /* TOOLBAR */
    .toolbar {
      display: flex; gap: 10px; align-items: center;
      padding: 12px 20px; border-bottom: 1px solid var(--stroke);
    }
    input, select, button {
      border-radius: 10px; border: 1px solid var(--stroke);
      background: #0f1115; color: var(--text); padding: 10px 12px;
    }
    button { cursor: pointer; background: #1f2937; transition: background .15s ease; }
    button:hover { background: #2b3648; }
    /* GRID */
    .content { padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .card {
      background: var(--panel); border: 1px solid var(--stroke);
      border-radius: var(--radius); padding: 16px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.25);
      display: flex; flex-direction: column; min-height: 220px;
    }
    .title { font-size: 18px; margin: 0 0 6px; line-height: 1.2; }
    .price { font-weight: 600; margin: 0 0 10px; }
    .desc { font-size: 13px; color: var(--muted); margin: 0 0 12px;
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .meta { font-size: 12px; color: var(--muted); margin-top: auto; }
    .row-end { margin-top: 10px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .sku { font-size: 11px; color: var(--muted); max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .cta { padding: 10px 12px; }
    /* BANNER (errors / preview) */
    .banner {
      background:#1f2937; border:1px solid var(--stroke);
      padding:10px 12px; border-radius:12px; margin: 12px 20px 0; font-size:12px; color:#d1d5db;
    }
    .warn { color: var(--brand); font-weight:600; }
    /* MODAL */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
    .modal-card { width: 100%; max-width: 480px; background: #0f1115; border: 1px solid var(--stroke); border-radius: var(--radius); padding: 18px; }
    .modal h2 { margin: 0 0 12px; }
    .modal .row { display: flex; gap: 8px; margin-top: 8px; }
    .modal textarea { width:100%; height: 90px; border-radius: 10px; border:1px solid var(--stroke); background:#0f1115; color:var(--text); padding:10px; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <img src="/logo-genosis.png" alt="Genosis" class="logo" />
    <div class="brand"><strong>Genosis</strong> Product Menu</div>
  </div>

  <!-- Optional banner (shows only if API falls back) -->
  <div class="banner" id="banner" style="display:none;"></div>

  <!-- Toolbar -->
  <div class="toolbar">
    <input id="search" placeholder="Search products..." />
    <select id="perPage" title="Items per load">
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="200" selected>200</option>
    </select>
    <button id="refresh">Refresh</button>
  </div>

  <!-- Content -->
  <div class="content">
    <div class="grid" id="grid"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="leadModal">
    <div class="modal-card">
      <h2 id="modalTitle">Request info</h2>
      <div class="row"><input id="firstName" placeholder="First name (optional)" /></div>
      <div class="row"><input id="lastName" placeholder="Last name (required)" /></div>
      <div class="row"><input id="email" type="email" placeholder="Email (optional)" /></div>
      <div class="row"><input id="phone" placeholder="Phone (optional)" /></div>
      <div class="row"><textarea id="notes" placeholder="Notes (optional)"></textarea></div>
      <div class="row" style="justify-content: flex-end; margin-top: 10px;">
        <button id="cancelBtn">Cancel</button>
        <button class="cta" id="createLeadBtn">Send request</button>
      </div>
    </div>
  </div>

  <script>
    // Mock fallback for preview-only situations
    const DEMO_ITEMS = [
      { id: '1', name: 'Free Base 0.63%', rate: 3800, description: 'Demo item from mock data', sku: 'Kratom_&_7OH_0.63' },
      { id: '2', name: 'Free Base 0.7%',  rate: 4800, description: 'Demo item from mock data', sku: 'Kratom_&_7OH_0.7'  },
      { id: '3', name: 'Free Base 0.8%',  rate: 5100, description: 'Demo item from mock data', sku: 'Kratom_&_7OH_0.8'  },
      { id: '4', name: 'Free Base 0.88%', rate: 5700, description: 'Demo item from mock data', sku: 'Kratom_&_7OH_0.88' }
    ];

    const grid = document.getElementById('grid');
    const banner = document.getElementById('banner');
    const search = document.getElementById('search');
    const perPage = document.getElementById('perPage');
    const refreshBtn = document.getElementById('refresh');

    const leadModal = document.getElementById('leadModal');
    const modalTitle = document.getElementById('modalTitle');
    const firstNameEl = document.getElementById('firstName');
    const lastNameEl = document.getElementById('lastName');
    const emailEl = document.getElementById('email');
    const phoneEl = document.getElementById('phone');
    const notesEl = document.getElementById('notes');
    const cancelBtn = document.getElementById('cancelBtn');
    const createLeadBtn = document.getElementById('createLeadBtn');

    let allItems = [];
    let selectedProduct = null;
    let preview = false;

    async function fetchItems(page = 1) {
      const res = await fetch(`/api/items?page=${page}&per_page=${perPage.value}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function loadAll() {
      grid.innerHTML = '';
      let page = 1; let items = []; let hasMore = true;
      try {
        while (hasMore) {
          const data = await fetchItems(page);
          const chunk = (data.items || []).map(x => ({
            id: x.item_id,
            name: x.name,
            rate: x.rate,
            description: (x.description || '').trim(),
            sku: x.sku || x.item_name || ''
          }));
          items = items.concat(chunk);
          const ctx = data.page_context || {};
          const current = ctx.page || page;
          const total = ctx.total_pages || 1;
          hasMore = current < total;
          page++;
        }
        allItems = items;
      } catch (e) {
        preview = true;
        allItems = DEMO_ITEMS;
        banner.style.display = 'block';
        banner.innerHTML = '<span class="warn">Preview mode:</span> Showing mock products because the API did not return live data.';
      }
      render();
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));
    }

    function render() {
      const q = (search.value || '').toLowerCase();
      const filtered = allItems.filter(i => i.name.toLowerCase().includes(q) || (i.sku||'').toLowerCase().includes(q));

      grid.innerHTML = '';
      if (!filtered.length) {
        grid.innerHTML = '<div class="card">No products found.</div>';
        return;
      }
      for (const item of filtered) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3 class="title">${escapeHtml(item.name)}</h3>
          <div class="price">$${Number(item.rate || 0).toLocaleString()}</div>
          <p class="desc">${escapeHtml(item.description)}</p>
          <div class="meta">
            <span class="sku" title="${escapeHtml(item.sku || '')}">SKU: ${escapeHtml(item.sku || '')}</span>
          </div>
          <div class="row-end">
            <span></span>
            <button class="cta">Request info</button>
          </div>
        `;
        card.querySelector('.cta').addEventListener('click', () => openLeadModal(item));
        grid.appendChild(card);
      }
    }

    function openLeadModal(item) {
      selectedProduct = item;
      modalTitle.textContent = `Request info: ${item.name}`;
      firstNameEl.value = '';
      lastNameEl.value = '';
      emailEl.value = '';
      phoneEl.value = '';
      notesEl.value = '';
      leadModal.style.display = 'flex';
    }

    cancelBtn.addEventListener('click', () => {
      leadModal.style.display = 'none';
      selectedProduct = null;
    });

    createLeadBtn.addEventListener('click', async () => {
      if (!selectedProduct) return;
      const lastName = (lastNameEl.value || '').trim();
      if (!lastName) { alert('Please add your last name.'); return; }

      if (preview) {
        alert('Demo mode: request would be sent for ' + selectedProduct.name);
        leadModal.style.display = 'none';
        selectedProduct = null;
        return;
      }
      const payload = {
        firstName: (firstNameEl.value || '').trim() || undefined,
        lastName,
        email: (emailEl.value || '').trim() || undefined,
        phone: (phoneEl.value || '').trim() || undefined,
        productName: selectedProduct.name,
        notes: (notesEl.value || '').trim() || undefined
      };
      const res = await fetch('/api/lead', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert('Request failed: ' + (json.message || json.error || res.status));
        return;
      }
      alert('Thanks! Weâ€™ll reach out shortly.');
      leadModal.style.display = 'none';
      selectedProduct = null;
    });

    search.addEventListener('input', render);
    refreshBtn.addEventListener('click', loadAll);

    loadAll();
  </script>
</body>
</html>
