<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Genosis â€¢ Product Menu</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#111318; --stroke:#1f2937; --muted:#9ca3af; --text:#e5e7eb;
      /* Gold accents (tweak to match logo exactly) */
      --accent1:#d4af37; /* light gold */
      --accent2:#b57f2a; /* deep gold  */
      --radius:16px;
    }
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--text)}

    /* HEADER */
    .header{
      display:flex;align-items:center;gap:12px;
      padding:14px 20px;position:sticky;top:0;z-index:10;
      background:rgba(11,12,16,.9);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--stroke)
    }
    .logo{height:34px;width:auto;display:block}
    .brandline{font-size:14px;color:var(--text);letter-spacing:.02em}
    .brandline .muted{color:var(--muted)}

    /* TOOLBAR */
    .toolbar{display:flex;gap:10px;align-items:center;padding:12px 20px;border-bottom:1px solid var(--stroke)}
    input,select,button{border-radius:10px;border:1px solid var(--stroke);background:#0f1115;color:var(--text);padding:10px 12px}
    button{cursor:pointer;background:#1f2937;transition:background .15s ease,border-color .15s ease,box-shadow .15s ease}
    button:hover{background:#2b3648}
    .content{padding:20px}

    /* GRID + CARDS */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{
      background:var(--panel);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px;
      box-shadow:0 10px 20px rgba(0,0,0,.25);display:flex;flex-direction:column;min-height:260px
    }
    .card:hover{
      border-color:var(--accent1);
      box-shadow:0 0 0 1px var(--accent1),0 10px 22px rgba(0,0,0,.28)
    }
    .title{font-size:18px;margin:0 0 6px;line-height:1.2}
    .price{font-weight:600;margin:0 0 10px}
    .desc{font-size:13px;color:var(--muted);margin:0 0 10px;
      display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
    .row{display:flex;gap:8px;align-items:center}
    .row-end{margin-top:auto;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sku{font-size:11px;color:var(--muted);max-width:60%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Controls on card */
    .select{
      width:100%;
      border-radius:10px;border:1px solid var(--stroke);background:#0f1115;color:var(--text);padding:8px 10px;
      transition:border-color .15s ease,box-shadow .15s ease
    }
    .select:focus{outline:none;border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1)}

    /* CTA button */
    .cta{
      padding:10px 12px;border:1px solid var(--stroke);background:#0f1115
    }
    .cta:hover{border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1)}
    .cta[disabled]{opacity:.55;cursor:not-allowed}

    /* Banner for preview/errors */
    .banner{
      background:#1f2937;border:1px solid var(--stroke);padding:10px 12px;border-radius:12px;margin:12px 20px 0;font-size:12px;color:#d1d5db
    }
    .warn{color:var(--accent1);font-weight:600}

    /* MODAL */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
    .modal-card{width:100%;max-width:480px;background:#0f1115;border:1px solid var(--stroke);border-radius:var(--radius);padding:18px}
    .modal-card h2{margin:0 0 12px}
    .modal .row{display:flex;gap:8px;margin-top:8px}
    .modal input,.modal textarea{
      width:100%;border-radius:10px;border:1px solid var(--stroke);background:#0f1115;color:var(--text);padding:10px
    }
    .modal input:focus,.modal textarea:focus{outline:none;border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1)}
    .modal textarea{height:90px}
    .modal .btn{padding:10px 12px;border:1px solid var(--stroke);background:#0f1115}
    .modal .btn:hover{border-color:var(--accent1);box-shadow:0 0 0 1px var(--accent1)}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <img src="/logo-genosis.png" alt="Genosis" class="logo" />
    <div class="brandline"><span class="muted">Product Menu</span></div>
  </div>

  <!-- Optional banner -->
  <div class="banner" id="banner" style="display:none;"></div>

  <!-- Toolbar -->
  <div class="toolbar">
    <input id="search" placeholder="Search products..." />
    <select id="perPage" title="Items per load">
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="200" selected>200</option>
    </select>
    <button id="refresh">Refresh</button>
  </div>

  <div class="content">
    <div class="grid" id="grid"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="leadModal">
    <div class="modal-card">
      <h2 id="modalTitle">Place order</h2>
      <div class="row"><input id="firstName" placeholder="First name" required /></div>
      <div class="row"><input id="lastName" placeholder="Last name" required /></div>
      <div class="row"><input id="email" type="email" placeholder="Email" required /></div>
      <div class="row"><input id="phone" placeholder="Phone" required /></div>
      <div class="row"><textarea id="notes" placeholder="Notes (optional)"></textarea></div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" id="cancelBtn">Cancel</button>
        <button class="btn" id="createLeadBtn">Submit</button>
      </div>
    </div>
  </div>

  <script>
    // Fallback demo data (only if API fails)
    const DEMO_ITEMS = [
      { id:'1', name:'Free Base 0.63%', rate:3800, description:'Demo item', sku:'Kratom_&_7OH_0.63' },
      { id:'2', name:'Free Base 0.7%', rate:4800, description:'Demo item', sku:'Kratom_&_7OH_0.7' },
      { id:'3', name:'Free Base 0.8%', rate:5100, description:'Demo item', sku:'Kratom_&_7OH_0.8' },
      { id:'4', name:'Free Base 0.88%', rate:5700, description:'Demo item', sku:'Kratom_&_7OH_0.88' }
    ];

    const grid = document.getElementById('grid');
    const banner = document.getElementById('banner');
    const search = document.getElementById('search');
    const perPage = document.getElementById('perPage');
    const refreshBtn = document.getElementById('refresh');

    const leadModal = document.getElementById('leadModal');
    const modalTitle = document.getElementById('modalTitle');
    const firstNameEl = document.getElementById('firstName');
    const lastNameEl = document.getElementById('lastName');
    const emailEl = document.getElementById('email');
    const phoneEl = document.getElementById('phone');
    const notesEl = document.getElementById('notes');
    const createLeadBtn = document.getElementById('createLeadBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    let allItems = [];
    let selectedProduct = null;
    let preview = false;
    let selectedWeight = '';

    async function fetchItems(page=1){
      const res = await fetch(`/api/items?page=${page}&per_page=${perPage.value}`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function loadAll(){
      grid.innerHTML = '';
      let page=1, items=[], hasMore=true;
      try{
        while(hasMore){
          const data = await fetchItems(page);
          const chunk = (data.items||[]).map(x => ({
            id: x.item_id,
            name: x.name,
            rate: x.rate,
            description: (x.description||'').trim(),
            sku: x.sku || x.item_name || '',
            // if you later store a custom field "weight_options" (CSV), it will be used
            weight_options: (x.weight_options || '').trim()
          }));
          items = items.concat(chunk);
          const ctx = data.page_context || {};
          const current = ctx.page || page;
          const total = ctx.total_pages || 1;
          hasMore = current < total; page++;
        }
        allItems = items;
      }catch(e){
        preview = true;
        allItems = DEMO_ITEMS;
        banner.style.display='block';
        banner.innerHTML='<span class="warn">Preview mode:</span> Showing mock products because the API did not return live data.';
      }
      render();
    }

    function escapeHtml(s){return String(s).replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

    // Default weight list; override if item carries a custom field "weight_options"
    const DEFAULT_WEIGHTS = ['250 g','500 g','1 kg','5 kg','10 kg'];

    function parseWeights(csv){
      if(!csv) return DEFAULT_WEIGHTS;
      const arr = csv.split(',').map(s=>s.trim()).filter(Boolean);
      return arr.length ? arr : DEFAULT_WEIGHTS;
    }

    function render(){
      const q = (search.value||'').toLowerCase();
      const filtered = allItems.filter(i => i.name.toLowerCase().includes(q) || (i.sku||'').toLowerCase().includes(q));
      grid.innerHTML = '';
      if(!filtered.length){ grid.innerHTML='<div class="card">No products found.</div>'; return; }

      for(const item of filtered){
        const card = document.createElement('div');
        card.className='card';

        // weight options
        const weights = parseWeights(item.weight_options);

        card.innerHTML = ''
          + '<h3 class="title">' + escapeHtml(item.name) + '</h3>'
          + '<div class="price">$' + Number(item.rate||0).toLocaleString() + '</div>'
          + '<p class="desc">' + escapeHtml(item.description) + '</p>'
          + '<div class="row">'
          +   '<select class="select weight-select" aria-label="Select weight">'
          +     '<option value="">Select weight</option>'
          +     (weights.map(function(w){ return '<option value="' + escapeHtml(w) + '">' + escapeHtml(w) + '</option>'; }).join(''))
          +   '</select>'
          + '</div>'
          + '<div class="row-end">'
          +   '<span class="sku" title="' + escapeHtml(item.sku||'') + '">SKU: ' + escapeHtml(item.sku||'') + '</span>'
          +   '<button class="cta place-btn" disabled>Place order</button>'
          + '</div>';

        const weightSel = card.querySelector('.weight-select');
        const placeBtn  = card.querySelector('.place-btn');

        weightSel.addEventListener('change', ()=>{
          placeBtn.disabled = !weightSel.value;
        });

        placeBtn.addEventListener('click', ()=>{
          if(!weightSel.value){ alert('Please choose a weight.'); return; }
          openLeadModal(item, weightSel.value);
        });

        grid.appendChild(card);
      }
    }

    function openLeadModal(item, weight){
      selectedProduct = item;
      selectedWeight  = weight;
      modalTitle.textContent = `Place order: ${item.name}`;
      firstNameEl.value = ''; lastNameEl.value = ''; emailEl.value = ''; phoneEl.value = ''; notesEl.value = '';
      leadModal.style.display='flex';
    }

    cancelBtn.addEventListener('click', ()=>{
      leadModal.style.display='none';
      selectedProduct=null; selectedWeight='';
    });

    createLeadBtn.addEventListener('click', async ()=>{
      if(!selectedProduct) return;

      // required fields
      if(!firstNameEl.value.trim()){ firstNameEl.focus(); return alert('Please enter your first name.'); }
      if(!lastNameEl.value.trim()){ lastNameEl.focus(); return alert('Please enter your last name.'); }
      if(!emailEl.value.trim()){ emailEl.focus(); return alert('Please enter your email.'); }
      if(!phoneEl.value.trim()){ phoneEl.focus(); return alert('Please enter your phone.'); }

      if(preview){
        alert(`Demo mode: would place order for ${selectedProduct.name} (${selectedWeight}).`);
        leadModal.style.display='none'; selectedProduct=null; selectedWeight=''; return;
      }

      const payload = {
        firstName: firstNameEl.value.trim(),
        lastName:  lastNameEl.value.trim(),
        email:     emailEl.value.trim(),
        phone:     phoneEl.value.trim(),
        productName: selectedProduct.name,
        notes: (notesEl.value||'').trim() ? `Weight: ${selectedWeight}\n${notesEl.value.trim()}` : `Weight: ${selectedWeight}`
      };

      const res = await fetch('/api/lead', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const json = await res.json().catch(()=> ({}));
      if(!res.ok){ return alert('Request failed: ' + (json.message || json.error || res.status)); }

      alert('Thanks! Your order request has been sent.');
      leadModal.style.display='none'; selectedProduct=null; selectedWeight='';
    });

    search.addEventListener('input', render);
    refreshBtn.addEventListener('click', loadAll);
    loadAll();
  </script>
</body>
</html>